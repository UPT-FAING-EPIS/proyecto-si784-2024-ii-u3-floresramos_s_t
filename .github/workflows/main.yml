name: Unified Testing & Analysis Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  generate-and-publish:
    name: Generate Reports and Publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Semgrep Analysis
      - name: Run Semgrep
        run: |
          docker pull semgrep/semgrep
          mkdir -p reports/security
          docker run --rm -v $(pwd):/src semgrep/semgrep semgrep scan --config="p/default" --json --output reports/security/semgrep.json

      - name: Install prospector-html
        run: python -m pip install prospector2html

      - name: Convert Semgrep results to HTML
        run: |
          cd reports/security
          prospector-html --input semgrep.json --output semgrep-report.html --filter semgrep || true
      
      # Snyk Analysis
      - uses: snyk/actions/setup@master
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install snyk-to-html
        run: npm install -g snyk-to-html

      - name: Run Snyk test
        run: |
          mkdir -p reports/security
          snyk code test --json | snyk-to-html -o reports/security/snyk-report.html
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      
      # BDD Tests
      # BDD Tests y Summary
      - name: Run BDD Tests and Generate Summary
        run: |
          cd PROYECTO_PDF
          
          # Limpiar y crear directorios
          rm -rf TestResults
          mkdir -p TestResults
          
          # Ejecutar pruebas con configuraci√≥n espec√≠fica
          dotnet test \
            --filter "Category=BDD" \
            --logger "trx;LogFileName=TestResults/bdd-results.trx" \
            --results-directory:./TestResults \
            --verbosity normal
          
          # Debug: Mostrar estructura de directorios
          echo "::notice title=Debug::Mostrando estructura de directorios"
          ls -R ./TestResults
          
          # Crear el summary
          echo "# üß™ BDD Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar archivo trx
          if [ -f "./TestResults/bdd-results.trx" ]; then
            echo "::notice title=Debug::Archivo TRX encontrado"
            
            # Extraer informaci√≥n b√°sica
            echo "## üìä Test Execution Results" >> $GITHUB_STEP_SUMMARY
            
            echo "### Features ejecutados:" >> $GITHUB_STEP_SUMMARY
            echo "- PDF Generation Feature" >> $GITHUB_STEP_SUMMARY
            echo "  - Generate PDF with valid data" >> $GITHUB_STEP_SUMMARY
            echo "  - Handle PDF generation errors" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### User Management Feature" >> $GITHUB_STEP_SUMMARY
            echo "- User Registration" >> $GITHUB_STEP_SUMMARY
            echo "  - Register new user" >> $GITHUB_STEP_SUMMARY
            echo "  - Handle duplicate registration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### Authentication Feature" >> $GITHUB_STEP_SUMMARY
            echo "- Login Process" >> $GITHUB_STEP_SUMMARY
            echo "  - Successful login" >> $GITHUB_STEP_SUMMARY
            echo "  - Failed login handling" >> $GITHUB_STEP_SUMMARY
            
            # Extraer estad√≠sticas del archivo trx
            total=$(grep -c "<UnitTestResult" "./TestResults/bdd-results.trx" || echo "0")
            passed=$(grep -c "outcome=\"Passed\"" "./TestResults/bdd-results.trx" || echo "0")
            failed=$(grep -c "outcome=\"Failed\"" "./TestResults/bdd-results.trx" || echo "0")
            
            echo "## üìà Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- Total Tests: $total" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Passed: $passed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ùå Failed: $failed" >> $GITHUB_STEP_SUMMARY
            
            # A√±adir anotaciones para GitHub Actions
            echo "::notice title=BDD Summary::Total: $total | ‚úÖ Passed: $passed | ‚ùå Failed: $failed"
          else
            echo "::warning title=BDD Tests::No se encontr√≥ el archivo de resultados en TestResults/"
            echo "## ‚ö†Ô∏è Test Execution Status" >> $GITHUB_STEP_SUMMARY
            echo "No se pudo encontrar el archivo de resultados de las pruebas BDD." >> $GITHUB_STEP_SUMMARY
            echo "Verifique que las pruebas est√©n configuradas correctamente." >> $GITHUB_STEP_SUMMARY
            
            # Mostrar contenido del directorio para debug
            echo "### üîç Debug Information" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -R . >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi


      # Create main dashboard
      - name: Create Dashboard
        run: |
          cat > reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Testing Results Dashboard</title>
            <style>
              body { 
                font-family: Arial; 
                max-width: 1200px; 
                margin: 0 auto; 
                padding: 20px; 
                background-color: #f5f5f5;
              }
              .card { 
                border: 1px solid #ddd; 
                padding: 20px; 
                margin: 20px 0; 
                border-radius: 8px;
                background-color: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              .card h2 {
                color: #333;
                margin-top: 0;
                border-bottom: 2px solid #2196F3;
                padding-bottom: 10px;
              }
              .metric { 
                font-size: 24px; 
                color: #2196F3; 
              }
              a {
                display: inline-block;
                padding: 10px 20px;
                background-color: #2196F3;
                color: white;
                text-decoration: none;
                border-radius: 4px;
                transition: background-color 0.3s;
                margin: 5px;
              }
              a:hover {
                background-color: #1976D2;
              }
              .report-links {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              }
            </style>
          </head>
          <body>
            <h1>Testing Results Dashboard</h1>
            
            <div class="card">
              <h2>Security Analysis</h2>
              <div class="report-links">
                <a href="security/semgrep-report.html">Semgrep HTML Report</a>
                <a href="security/semgrep.json">Semgrep JSON Report</a>
                <a href="security/snyk-report.html">Snyk Report</a>
              </div>
            </div>
            
            <div class="card">
              <h2>BDD Test Results</h2>
              <a href="bdd/bdd-report.html">View BDD Test Report</a>
            </div>
          </body>
          </html>
          EOF

      # Deploy to gh-pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          force_orphan: true
